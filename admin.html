<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Production Monitoring</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <!-- Toastify for notifications -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <!-- Chart.js for analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f5ff',
              100: '#e0eaff',
              200: '#c7d7fe',
              300: '#a4bcfd',
              400: '#8098f9',
              500: '#6172f3',
              600: '#4f46e5',
              700: '#4438ca',
              800: '#372fa2',
              900: '#312e81',
            },
            dark: {
              50: '#f6f6f6',
              100: '#e7e7e7',
              200: '#d1d1d1',
              300: '#b0b0b0',
              400: '#888888',
              500: '#6d6d6d',
              600: '#5d5d5d',
              700: '#4f4f4f',
              800: '#454545',
              900: '#3d3d3d',
              950: '#1f1f1f',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out forwards',
            'slide-in': 'slideIn 0.3s ease-out forwards',
            'bounce-light': 'bounceLight 2s infinite',
            'pulse-light': 'pulseLight 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideIn: {
              '0%': { transform: 'translateY(10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            bounceLight: {
              '0%, 20%, 53%, 80%, 100%': { transform: 'translateZ(0)' },
              '40%, 43%': { transform: 'translate3d(0, -5px, 0)' },
              '70%': { transform: 'translate3d(0, -3px, 0)' },
              '90%': { transform: 'translate3d(0, -1px, 0)' },
            },
            pulseLight: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '.8' },
            }
          }
        }
      }
    }
  </script>
  <style type="text/css">
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    
    .sidebar-transition {
      transition: all 0.3s ease;
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
    
    .dark .card-hover:hover {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.3);
    }
    
    .btn-transition {
      transition: all 0.2s ease-in-out;
    }
    
    .btn-transition:hover {
      transform: translateY(-2px);
    }
    
    .btn-transition:active {
      transform: translateY(0);
    }
    
    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c5c5c5;
      border-radius: 10px;
    }
    
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-track {
      background: #2d2d2d;
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #555;
    }
    
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #777;
    }
    
    /* Table row animation */
    @keyframes fadeInRow {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .table-row {
      animation: fadeInRow 0.3s ease-out forwards;
    }
    
    /* Glass morphism effect */
    .glass-effect {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .dark .glass-effect {
      background: rgba(30, 30, 30, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Toggle switch */
    .theme-toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .theme-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4f46e5;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    /* Shimmer loading effect */
    .shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }
    
    .dark .shimmer {
      background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
      background-size: 200% 100%;
    }
    
    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased dark:bg-dark-950 dark:text-gray-200">
  <div class="flex h-screen overflow-hidden">
    <!-- Main Content -->
    <div class="flex flex-col flex-1">
      <!-- Header -->
      <header class="glass-effect sticky top-0 z-40 border-b border-gray-200 dark:border-dark-700">
        <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
          <div class="flex items-center">
            <div class="h-8 w-8 rounded-lg bg-primary-600 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L9 9.414V13a1 1 0 11-2 0V9.414l-1.293 1.293a1 1 0 01-1.414 0z" clip-rule="evenodd" />
              </svg>
            </div>
            <h1 class="ml-2 text-2xl font-semibold text-gray-800 dark:text-white">WeaveTrack - Production Dashboard</h1>
          </div>
          <div class="flex items-center space-x-4">
            <div class="flex items-center px-3 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-800 dark:text-primary-200 text-sm font-medium">
              <div class="w-2 h-2 rounded-full bg-primary-600 mr-2"></div>
              <span id="connectionStatus">Server Connected</span>
            </div>
            <div class="flex items-center px-2">
              <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-2">Dark Mode</span>
              <label class="theme-toggle">
                <input type="checkbox" id="darkModeToggle">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <button id="addLoomBtn" class="btn-transition flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg font-medium shadow-md hover:bg-primary-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark-900">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
              </svg>
              Add New Loom
            </button>
          </div>
        </div>
      </header>

      <main class="flex-1 p-6 overflow-y-auto custom-scrollbar">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="card-hover bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-dark-700 animate-fade-in">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Total Production Today</h2>
                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="totalProduction">0 m</p>
              </div>
            </div>
          </div>
          
          <div class="card-hover bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-dark-700 animate-fade-in" style="animation-delay: 0.1s">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-green-50 dark:bg-green-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Average Efficiency</h2>
                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="avgEfficiency">0%</p>
              </div>
            </div>
          </div>
          
          <div class="card-hover bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-dark-700 animate-fade-in" style="animation-delay: 0.2s">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-purple-50 dark:bg-purple-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500 dark:text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Active Looms</h2>
                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="activeLooms">0</p>
              </div>
            </div>
          </div>
          
          <div class="card-hover bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-dark-700 animate-fade-in" style="animation-delay: 0.3s">
            <div class="flex items-center">
              <div class="p-3 rounded-lg bg-orange-50 dark:bg-orange-900/30">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500 dark:text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
              </div>
              <div class="ml-4">
                <h2 class="text-gray-500 dark:text-gray-400 text-sm font-medium">Entries Today</h2>
                <p class="text-2xl font-bold text-gray-800 dark:text-white" id="entriesToday">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 mb-8 border border-gray-100 dark:border-dark-700 animate-slide-in">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date Range</label>
              <select class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="dateRange">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom</option>
              </select>
            </div>
            
            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Shift</label>
              <select class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="shiftFilter">
                <option value="">All Shifts</option>
                <option value="A">Shift A</option>
                <option value="B">Shift B</option>
                <option value="C">Shift C</option>
              </select>
            </div>
            
            <div class="flex flex-col" id="customDateRange" style="display: none;">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">From Date</label>
              <input type="date" class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="fromDate">
            </div>
            
            <div class="flex flex-col" id="customDateRangeTo" style="display: none;">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To Date</label>
              <input type="date" class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="toDate">
            </div>
            
            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Loom Number</label>
              <input type="text" class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="loomFilter" list="loomList" placeholder="All Looms">
              <datalist id="loomList"></datalist>
            </div>
            
            <div class="flex flex-col">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buyer</label>
              <select class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white" id="buyerFilter">
                <option value="">All Buyers</option>
              </select>
            </div>
          </div>
          
          <div class="flex space-x-3">
            <button id="applyFilters" class="btn-transition bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark-800 transition-all duration-200">
              Apply Filters
            </button>
            <button id="resetFilters" class="btn-transition bg-gray-200 dark:bg-dark-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium shadow-sm hover:bg-gray-300 dark:hover:bg-dark-500 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-dark-800 transition-all duration-200">
              Reset Filters
            </button>
            <button id="exportBtn" class="btn-transition bg-white dark:bg-dark-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium border border-gray-300 dark:border-dark-500 shadow-sm hover:bg-gray-50 dark:hover:bg-dark-500 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-dark-800 transition-all duration-200">
              Export Data
            </button>
          </div>
        </div>

        <!-- Analytics Chart -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 mb-8 border border-gray-100 dark:border-dark-700 animate-slide-in" style="animation-delay: 0.1s">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Production Analytics</h2>
            <select class="rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white text-sm" id="chartType">
              <option value="daily">Daily Production</option>
              <option value="shift">By Shift</option>
              <option value="loom">By Loom</option>
            </select>
          </div>
          <div class="h-80">
            <canvas id="productionChart"></canvas>
          </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white dark:bg-dark-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-dark-700 animate-slide-in" style="animation-delay: 0.2s">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Production Data</h2>
            <div class="text-sm text-gray-500 dark:text-gray-400" id="tableInfo">Showing 0 entries</div>
          </div>
          
          <div class="overflow-x-auto custom-scrollbar">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-dark-700">
              <thead class="bg-gray-50 dark:bg-dark-700">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Loom No</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Buyer</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Construction</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Shift</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Production (m)</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Efficiency</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-dark-800 divide-y divide-gray-200 dark:divide-dark-700" id="dataTableBody">
                <tr>
                  <td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Loading data...</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-700 dark:text-gray-400">
              Showing <span id="paginationStart">0</span> to <span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> results
            </div>
            <div class="flex space-x-2">
              <button id="prevPage" class="px-3 py-1 rounded-md bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Previous
              </button>
              <button id="nextPage" class="px-3 py-1 rounded-md bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Next
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Loom Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden transition-opacity duration-300 ease-in-out" id="addLoomModal">
    <div class="bg-white dark:bg-dark-800 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="modalDialog">
      <div class="p-6 border-b border-gray-200 dark:border-dark-700">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Add New Loom</h2>
      </div>
      
      <form id="loomForm" class="p-6">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Loom Number *</label>
          <input type="text" class="w-full rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white transition-colors duration-200" id="modalLoomNo" required>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buyer Name *</label>
          <input type="text" class="w-full rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white transition-colors duration-200" id="modalBuyer" required>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Construction *</label>
          <input type="text" class="w-full rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white transition-colors duration-200" id="modalConstruction" required>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Additional Details</label>
          <textarea class="w-full rounded-lg border-gray-300 dark:border-dark-600 shadow-sm focus:border-primary-500 focus:ring focus:ring-primary-500 focus:ring-opacity-50 py-2 px-3 bg-white dark:bg-dark-700 text-gray-900 dark:text-white transition-colors duration-200" id="modalDetails" rows="3"></textarea>
        </div>
        
        <div class="flex justify-end space-x-3">
          <button type="button" class="btn-transition bg-white dark:bg-dark-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg font-medium border border-gray-300 dark:border-dark-500 shadow-sm hover:bg-gray-50 dark:hover:bg-dark-500 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:focus:ring-offset-dark-800 transition-all duration-200" id="cancelLoom">
            Cancel
          </button>
          <button type="submit" class="btn-transition bg-primary-600 text-white px-4 py-2 rounded-lg font-medium shadow-md hover:bg-primary-700 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-dark-800 transition-all duration-200">
            Save Loom
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Firebase configuration - replace with your actual config
    const firebaseConfig = {
      apiKey: "AIzaSyDuaWMh0eIJ2tdtLxYj43ij9MGSh_Yo22M",
      authDomain: "test-6977e.firebaseapp.com",
      databaseURL: "https://test-6977e-default-rtdb.firebaseio.com/",
      projectId: "test-6977e",
      storageBucket: "test-6977e.firebasestorage.app",
      messagingSenderId: "544329273038",
      appId: "1:544329273038:web:c7a31e12bec7c80741ca9f"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // DOM elements
    const addLoomBtn = document.getElementById('addLoomBtn');
    const addLoomModal = document.getElementById('addLoomModal');
    const modalDialog = document.getElementById('modalDialog');
    const cancelLoomBtn = document.getElementById('cancelLoom');
    const loomForm = document.getElementById('loomForm');
    const dataTableBody = document.getElementById('dataTableBody');
    const applyFiltersBtn = document.getElementById('applyFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const dateRangeSelect = document.getElementById('dateRange');
    const shiftFilter = document.getElementById('shiftFilter');
    const customDateRange = document.getElementById('customDateRange');
    const customDateRangeTo = document.getElementById('customDateRangeTo');
    const loomFilter = document.getElementById('loomFilter');
    const buyerFilter = document.getElementById('buyerFilter');
    const exportBtn = document.getElementById('exportBtn');
    const tableInfo = document.getElementById('tableInfo');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const chartTypeSelect = document.getElementById('chartType');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const paginationStart = document.getElementById('paginationStart');
    const paginationEnd = document.getElementById('paginationEnd');
    const paginationTotal = document.getElementById('paginationTotal');
    
    // Global variables
    let productionChart;
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredData = [];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Check for saved dark mode preference
      if (localStorage.getItem('darkMode') === 'true') {
        document.documentElement.classList.add('dark');
        darkModeToggle.checked = true;
      }
      
      loadLoomData();
      loadProductionData();
      setupEventListeners();
      initCharts();
    });
    
    function setupEventListeners() {
      // Modal handlers
      addLoomBtn.addEventListener('click', openModal);
      cancelLoomBtn.addEventListener('click', closeModal);
      
      // Click outside modal to close
      addLoomModal.addEventListener('click', function(e) {
        if (e.target === addLoomModal) {
          closeModal();
        }
      });
      
      // Form submission
      loomForm.addEventListener('submit', handleLoomSubmit);
      
      // Filter handlers
      dateRangeSelect.addEventListener('change', function() {
        if (this.value === 'custom') {
          customDateRange.style.display = 'flex';
          customDateRangeTo.style.display = 'flex';
        } else {
          customDateRange.style.display = 'none';
          customDateRangeTo.style.display = 'none';
        }
      });
      
      applyFiltersBtn.addEventListener('click', function() {
        currentPage = 1;
        loadProductionData();
      });
      
      resetFiltersBtn.addEventListener('click', resetFilters);
      exportBtn.addEventListener('click', exportData);
      
      // Dark mode toggle
      darkModeToggle.addEventListener('change', function() {
        if (this.checked) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('darkMode', 'true');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('darkMode', 'false');
        }
        // Update chart colors when theme changes
        updateChart(filteredData);
      });
      
      // Chart type change
      chartTypeSelect.addEventListener('change', function() {
        loadProductionData();
      });
      
      // Pagination
      prevPageBtn.addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          renderDataTable();
        }
      });
      
      nextPageBtn.addEventListener('click', function() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderDataTable();
        }
      });
    }
    
    function openModal() {
      addLoomModal.classList.remove('hidden');
      setTimeout(() => {
        addLoomModal.classList.add('bg-opacity-50');
        modalDialog.classList.remove('scale-95', 'opacity-0');
        modalDialog.classList.add('scale-100', 'opacity-100');
      }, 10);
    }
    
    function closeModal() {
      modalDialog.classList.remove('scale-100', 'opacity-100');
      modalDialog.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        addLoomModal.classList.add('hidden');
        addLoomModal.classList.remove('bg-opacity-50');
        loomForm.reset();
      }, 300);
    }
    
    function resetFilters() {
      dateRangeSelect.value = 'today';
      shiftFilter.value = '';
      loomFilter.value = '';
      buyerFilter.value = '';
      customDateRange.style.display = 'none';
      customDateRangeTo.style.display = 'none';
      currentPage = 1;
      loadProductionData();
    }
    
    function loadLoomData() {
      // Load loom data for filter dropdown
      database.ref('looms').once('value')
        .then((snapshot) => {
          const looms = snapshot.val();
          if (looms) {
            loomList.innerHTML = '';
            buyerFilter.innerHTML = '<option value="">All Buyers</option>';
            
            const buyers = new Set();
            
            Object.entries(looms).forEach(([loomNo, loomData]) => {
              // Add to loom datalist
              const option = document.createElement('option');
              option.value = loomNo;
              loomList.appendChild(option);
              
              // Collect unique buyers
              if (loomData.buyer) {
                buyers.add(loomData.buyer);
              }
            });
            
            // Add buyers to filter dropdown
            buyers.forEach(buyer => {
              const option = document.createElement('option');
              option.value = buyer;
              option.textContent = buyer;
              buyerFilter.appendChild(option);
            });
          }
        })
        .catch((error) => {
          showToast('Error loading loom data: ' + error.message, 'error');
        });
    }
    
    function loadProductionData() {
      dataTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Loading data...</td></tr>';
      
      // Get filter values
      const loomValue = loomFilter.value.trim();
      const buyerValue = buyerFilter.value;
      const dateRangeValue = dateRangeSelect.value;
      const shiftValue = shiftFilter.value;
      
      let startDate, endDate;
      
      // Calculate date range
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      switch(dateRangeValue) {
        case 'today':
          startDate = today.getTime();
          endDate = Date.now();
          break;
        case 'yesterday':
          startDate = today.getTime() - 86400000;
          endDate = today.getTime() - 1;
          break;
        case 'week':
          // Start of week (Monday)
          const dayOfWeek = today.getDay();
          const diffToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
          startDate = today.getTime() - (diffToMonday * 86400000);
          endDate = Date.now();
          break;
        case 'month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1).getTime();
          endDate = Date.now();
          break;
        case 'custom':
          const fromDate = new Date(document.getElementById('fromDate').value);
          const toDate = new Date(document.getElementById('toDate').value);
          if (isNaN(fromDate.getTime()) || isNaN(toDate.getTime())) {
            showToast('Please select valid custom dates', 'error');
            return;
          }
          startDate = fromDate.getTime();
          toDate.setHours(23, 59, 59, 999);
          endDate = toDate.getTime();
          break;
        default:
          startDate = 0;
          endDate = Date.now();
      }
      
      // Query data with filters
      let entriesRef = database.ref('entries').orderByChild('timestamp');
      
      entriesRef.once('value')
        .then((snapshot) => {
          const entries = snapshot.val();
          if (!entries) {
            dataTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No data available</td></tr>';
            tableInfo.textContent = 'Showing 0 entries';
            updateStats({});
            updateChart({});
            return;
          }
          
          // Filter and process data
          filteredData = [];
          const stats = {
            totalProduction: 0,
            totalEfficiency: 0,
            count: 0,
            loomCount: new Set()
          };
          
          const promises = [];
          
          Object.entries(entries).forEach(([key, entry]) => {
            // Apply date filter
            if (entry.timestamp < startDate || entry.timestamp > endDate) {
              return;
            }
            
            // Apply shift filter
            if (shiftValue && entry.shift !== shiftValue) {
              return;
            }
            
            promises.push(
              database.ref('looms/' + entry.loom).once('value')
                .then((loomSnapshot) => {
                  const loomData = loomSnapshot.val();
                  
                  // Apply loom filter
                  if (loomValue && entry.loom !== loomValue) {
                    return;
                  }
                  
                  // Apply buyer filter
                  if (buyerValue && loomData.buyer !== buyerValue) {
                    return;
                  }
                  
                  // Add to filtered data
                  filteredData.push({
                    id: key,
                    ...entry,
                    buyer: loomData ? loomData.buyer : 'N/A',
                    construction: loomData ? loomData.construction : 'N/A'
                  });
                  
                  // Update stats
                  stats.totalProduction += entry.production;
                  stats.totalEfficiency += entry.eff;
                  stats.count++;
                  stats.loomCount.add(entry.loom);
                })
            );
          });
          
          Promise.all(promises).then(() => {
            if (filteredData.length === 0) {
              dataTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No data matching filters</td></tr>';
              tableInfo.textContent = 'Showing 0 entries';
              updateStats({});
              updateChart({});
              updatePagination(0);
            } else {
              renderDataTable();
              updateStats(stats);
              updateChart(filteredData);
              tableInfo.textContent = `Showing ${filteredData.length} entries`;
              updatePagination(filteredData.length);
            }
          });
        })
        .catch((error) => {
          dataTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">Error loading data</td></tr>';
          tableInfo.textContent = 'Error loading data';
          console.error('Error loading production data:', error);
        });
    }
    
    function renderDataTable() {
      dataTableBody.innerHTML = '';
      
      if (filteredData.length === 0) {
        dataTableBody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">No data available</td></tr>';
        return;
      }
      
      // Sort by date (newest first)
      filteredData.sort((a, b) => b.timestamp - a.timestamp);
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
      const pageData = filteredData.slice(startIndex, endIndex);
      
      // Update pagination buttons
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
      
      pageData.forEach((entry, index) => {
        const date = new Date(entry.timestamp);
        const formattedDate = date.toLocaleDateString();
        
        const row = document.createElement('tr');
        row.className = `table-row opacity-0`;
        row.style.animationDelay = `${index * 0.05}s`;
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${formattedDate}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${entry.loom}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${entry.buyer}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${entry.construction}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">Shift ${entry.shift}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${entry.production.toFixed(1)}m</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-200">${entry.eff}%</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button class="text-primary-600 dark:text-primary-400 hover:text-primary-900 dark:hover:text-primary-300 mr-3 transition-colors duration-200" onclick="editEntry('${entry.id}')">Edit</button>
            <button class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 transition-colors duration-200" onclick="deleteEntry('${entry.id}')">Delete</button>
          </td>
        `;
        
        dataTableBody.appendChild(row);
      });
    }
    
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
      
      paginationStart.textContent = totalItems === 0 ? 0 : startIndex + 1;
      paginationEnd.textContent = endIndex;
      paginationTotal.textContent = totalItems;
      
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
    }
    
    function updateStats(stats) {
      document.getElementById('totalProduction').textContent = 
        stats.totalProduction ? stats.totalProduction.toFixed(1) + 'm' : '0m';
      
      document.getElementById('avgEfficiency').textContent = 
        stats.count ? (stats.totalEfficiency / stats.count).toFixed(1) + '%' : '0%';
      
      document.getElementById('activeLooms').textContent = 
        stats.loomCount ? stats.loomCount.size : 0;
      
      document.getElementById('entriesToday').textContent = stats.count || 0;
    }
    
    function initCharts() {
      const ctx = document.getElementById('productionChart').getContext('2d');
      
      // Detect dark mode for chart colors
      const isDark = document.documentElement.classList.contains('dark');
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const textColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
      
      productionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Production (m)',
            data: [],
            backgroundColor: 'rgba(79, 70, 229, 0.7)',
            borderColor: 'rgba(79, 70, 229, 1)',
            borderWidth: 1,
            borderRadius: 6,
            hoverBackgroundColor: 'rgba(79, 70, 229, 0.9)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: gridColor,
                drawBorder: false
              },
              ticks: {
                color: textColor
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: textColor
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: isDark ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)',
              titleColor: isDark ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)',
              bodyColor: isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)',
              borderColor: 'rgba(79, 70, 229, 0.5)',
              borderWidth: 1
            }
          }
        }
      });
    }
    
    function updateChart(data) {
      if (!data || data.length === 0) {
        productionChart.data.labels = [];
        productionChart.data.datasets[0].data = [];
        productionChart.update();
        return;
      }
      
      const chartType = chartTypeSelect.value;
      let labels = [];
      let productionData = [];
      
      if (chartType === 'daily') {
        // Group by date
        const dailyProduction = {};
        
        data.forEach(entry => {
          const date = new Date(entry.timestamp).toLocaleDateString();
          if (!dailyProduction[date]) {
            dailyProduction[date] = 0;
          }
          dailyProduction[date] += entry.production;
        });
        
        labels = Object.keys(dailyProduction);
        productionData = Object.values(dailyProduction);
      } 
      else if (chartType === 'shift') {
        // Group by shift
        const shiftProduction = { A: 0, B: 0, C: 0 };
        
        data.forEach(entry => {
          if (shiftProduction.hasOwnProperty(entry.shift)) {
            shiftProduction[entry.shift] += entry.production;
          }
        });
        
        labels = ['Shift A', 'Shift B', 'Shift C'];
        productionData = [shiftProduction.A, shiftProduction.B, shiftProduction.C];
      }
      else if (chartType === 'loom') {
        // Group by loom
        const loomProduction = {};
        
        data.forEach(entry => {
          if (!loomProduction[entry.loom]) {
            loomProduction[entry.loom] = 0;
          }
          loomProduction[entry.loom] += entry.production;
        });
        
        labels = Object.keys(loomProduction);
        productionData = Object.values(loomProduction);
      }
      
      // Update chart data
      productionChart.data.labels = labels;
      productionChart.data.datasets[0].data = productionData;
      
      // Update chart colors based on theme
      const isDark = document.documentElement.classList.contains('dark');
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const textColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
      
      productionChart.options.scales.x.ticks.color = textColor;
      productionChart.options.scales.y.ticks.color = textColor;
      productionChart.options.scales.y.grid.color = gridColor;
      productionChart.options.plugins.tooltip.backgroundColor = isDark ? 'rgba(30, 30, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)';
      productionChart.options.plugins.tooltip.titleColor = isDark ? 'rgba(255, 255, 255, 0.9)' : 'rgba(0, 0, 0, 0.9)';
      productionChart.options.plugins.tooltip.bodyColor = isDark ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)';
      
      productionChart.update('reset');
    }
    
    function handleLoomSubmit(e) {
      e.preventDefault();
      
      const loomNo = document.getElementById('modalLoomNo').value.trim();
      const buyer = document.getElementById('modalBuyer').value.trim();
      const construction = document.getElementById('modalConstruction').value.trim();
      const details = document.getElementById('modalDetails').value.trim();
      
      if (!loomNo || !buyer || !construction) {
        showToast('Please fill all required fields', 'error');
        return;
      }
      
      const loomData = {
        buyer,
        construction,
        details,
        createdAt: Date.now()
      };
      
      database.ref('looms/' + loomNo).set(loomData)
        .then(() => {
          showToast('Loom added successfully!', 'success');
          closeModal();
          loadLoomData();
        })
        .catch((error) => {
          showToast('Error adding loom: ' + error.message, 'error');
        });
    }
    
    function editEntry(entryId) {
      // Implementation for editing an entry
      showToast('Edit functionality would be implemented here', 'info');
    }
    
    function deleteEntry(entryId) {
      if (confirm('Are you sure you want to delete this entry?')) {
        database.ref('entries/' + entryId).remove()
          .then(() => {
            showToast('Entry deleted successfully', 'success');
            loadProductionData();
          })
          .catch((error) => {
            showToast('Error deleting entry: ' + error.message, 'error');
          });
      }
    }
    
    function exportData() {
      if (filteredData.length === 0) {
        showToast('No data to export', 'warning');
        return;
      }
      
      // Prepare data for Excel
      const excelData = [['Date', 'Loom No', 'Buyer', 'Construction', 'Shift', 'Production (m)', 'Efficiency (%)']];
      
      filteredData.forEach(entry => {
        const date = new Date(entry.timestamp).toLocaleDateString();
        excelData.push([
          date,
          entry.loom,
          entry.buyer,
          entry.construction,
          'Shift ' + entry.shift,
          entry.production,
          entry.eff
        ]);
      });
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Production Data');
      
      // Generate Excel file and trigger download
      const fileName = `production_data_${new Date().toISOString().slice(0,10)}.xlsx`;
      XLSX.writeFile(wb, fileName);
      
      showToast('Data exported successfully as Excel file', 'success');
    }
    
    function showToast(message, type = 'info') {
      const backgroundColor = type === 'success' ? '#10B981' : 
                             type === 'error' ? '#EF4444' : 
                             type === 'warning' ? '#F59E0B' : '#3B82F6';
      
      Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: backgroundColor,
        stopOnFocus: true,
        className: "rounded-lg shadow-md font-medium",
      }).showToast();
    }
  </script>
</body>
</html>